<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horarios — Fornería</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .brand { color:#dc3545; font-weight:700; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><span class="h4 m-0 brand">Fornería</span></a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <img src="https://via.placeholder.com/90" alt="mifoto" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
        <span class="fw-semibold">Renato Muñoz</span>
      </div>
    </div>
  </nav>

  <!-- Contenido -->
  <div class="container-fluid py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 d-none d-md-block">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title text-muted mb-3">NAVEGACIÓN</h6>
            <ul class="nav nav-pills flex-column gap-2">
              {% with n=request.resolver_match.url_name %}
              <li class="nav-item">
                <a class="nav-link {% if n == 'dash_admin' %}active{% endif %}" href="{% url 'dash_admin' %}">
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'crud_cargo' %}active{% endif %}" href="{% url 'crud_cargo' %}">
                  <i class="bi bi-briefcase me-2"></i>Gestión de Cargos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'contratos_admin' %}active{% endif %}" href="{% url 'contratos_admin' %}">
                  <i class="bi bi-file-earmark-text me-2"></i>Contratos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'liquidaciones_admin' %}active{% endif %}" href="{% url 'liquidaciones_admin' %}">
                  <i class="bi bi-cash-coin me-2"></i>Liquidaciones
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'horarios_admin' %}active{% endif %}" href="{% url 'horarios_admin' %}">
                  <i class="bi bi-clock me-2"></i>Horarios
                </a>
              </li>
              {% endwith %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="col-lg-10 col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="m-0">Gestión de Horarios</h4>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'dash_admin' %}">Volver al dashboard</a>
            <button class="btn btn-primary btn-sm" id="btnNuevoHorario">
              <i class="bi bi-plus-circle me-1"></i>Nuevo Horario
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnExportar">Exportar (CSV)</button>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped align-middle" id="tablaHorarios">
                <thead class="table-light">
                  <tr>
                    <th>Día</th>
                    <th>Entrada</th>
                    <th>Salida</th>
                    <th>Descanso</th>
                    <th>Zona</th>
                    <th>Observación</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Los horarios se cargarán dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PARA CREAR/EDITAR HORARIO -->
  <div class="modal fade" id="modalHorario" tabindex="-1" aria-labelledby="modalHorarioLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalHorarioLabel">Nuevo Horario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formHorario">
            <input type="hidden" id="horarioId">
            <div class="mb-3">
              <label for="diaHorario" class="form-label">Día <span class="text-danger">*</span></label>
              <select class="form-select" id="diaHorario" required>
                <option value="">Seleccionar día...</option>
                <option value="Lunes">Lunes</option>
                <option value="Martes">Martes</option>
                <option value="Miércoles">Miércoles</option>
                <option value="Jueves">Jueves</option>
                <option value="Viernes">Viernes</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="entradaHorario" class="form-label">Hora de Entrada</label>
                <input type="time" class="form-control" id="entradaHorario">
              </div>
              <div class="col-md-6 mb-3">
                <label for="salidaHorario" class="form-label">Hora de Salida</label>
                <input type="time" class="form-control" id="salidaHorario">
              </div>
            </div>
            <div class="mb-3">
              <label for="descansoHorario" class="form-label">Horario de Descanso</label>
              <input type="text" class="form-control" id="descansoHorario" placeholder="Ej: 13:00 - 14:00">
              <div class="form-text">Formato: HH:MM - HH:MM</div>
            </div>
            <div class="mb-3">
              <label for="zonaHorario" class="form-label">Zona de Trabajo</label>
              <select class="form-select" id="zonaHorario">
                <option value="">Seleccionar zona...</option>
                <option value="Hornos">Hornos</option>
                <option value="Producción">Producción</option>
                <option value="Control calidad">Control calidad</option>
                <option value="Tienda">Tienda</option>
                <option value="Administración">Administración</option>
                <option value="Apoyo tienda">Apoyo tienda</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="observacionHorario" class="form-label">Observación</label>
              <textarea class="form-control" id="observacionHorario" rows="2" placeholder="Observaciones adicionales..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarHorario">
            <i class="bi bi-check-circle me-1"></i>Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======= Datos DEMO de horarios =======
    let horarios = [
      { id:1, dia:"Lunes", entrada:"08:00", salida:"17:00", descanso:"13:00 - 14:00", zona:"Hornos", observacion:"" },
      { id:2, dia:"Martes", entrada:"08:00", salida:"17:00", descanso:"13:00 - 14:00", zona:"Hornos", observacion:"Turno hornos" },
      { id:3, dia:"Miércoles", entrada:"08:00", salida:"17:00", descanso:"13:00 - 14:00", zona:"Control calidad", observacion:"" },
      { id:4, dia:"Jueves", entrada:"08:00", salida:"17:00", descanso:"13:00 - 14:00", zona:"Producción", observacion:"" },
      { id:5, dia:"Viernes", entrada:"08:00", salida:"16:00", descanso:"13:00 - 13:45", zona:"Producción", observacion:"Capacitación 10:00" },
      { id:6, dia:"Sábado", entrada:"09:00", salida:"13:00", descanso:"-", zona:"Apoyo tienda", observacion:"" },
      { id:7, dia:"Domingo", entrada:"-", salida:"-", descanso:"-", zona:"-", observacion:"Descanso" }
    ];

    const tablaHorarios = document.getElementById('tablaHorarios').querySelector('tbody');
    const btnNuevoHorario = document.getElementById('btnNuevoHorario');
    const modalHorario = new bootstrap.Modal(document.getElementById('modalHorario'));
    const formHorario = document.getElementById('formHorario');
    const btnGuardarHorario = document.getElementById('btnGuardarHorario');

    document.addEventListener('DOMContentLoaded', function() {
      renderTablaHorarios();
    });

    function renderTablaHorarios() {
      tablaHorarios.innerHTML = '';
      const ordenDias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
      const horariosOrdenados = [...horarios].sort((a,b) => ordenDias.indexOf(a.dia) - ordenDias.indexOf(b.dia));
      
      horariosOrdenados.forEach((horario) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-semibold">${horario.dia}</td>
          <td>${horario.entrada}</td>
          <td>${horario.salida}</td>
          <td>${horario.descanso}</td>
          <td>${horario.zona}</td>
          <td>${horario.observacion || '-'}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary btn-editar-horario" data-id="${horario.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-eliminar-horario" data-id="${horario.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tablaHorarios.appendChild(tr);
      });

      document.querySelectorAll('.btn-editar-horario').forEach(btn => {
        btn.addEventListener('click', () => editarHorario(parseInt(btn.dataset.id)));
      });
      document.querySelectorAll('.btn-eliminar-horario').forEach(btn => {
        btn.addEventListener('click', () => eliminarHorario(parseInt(btn.dataset.id)));
      });
    }

    btnNuevoHorario.addEventListener('click', () => {
      document.getElementById('modalHorarioLabel').textContent = 'Nuevo Horario';
      formHorario.reset();
      document.getElementById('horarioId').value = '';
      modalHorario.show();
    });

    function editarHorario(id) {
      const horario = horarios.find(h => h.id === id);
      if (!horario) return;

      document.getElementById('modalHorarioLabel').textContent = 'Editar Horario';
      document.getElementById('horarioId').value = horario.id;
      document.getElementById('diaHorario').value = horario.dia;
      document.getElementById('entradaHorario').value = horario.entrada !== '-' ? horario.entrada : '';
      document.getElementById('salidaHorario').value = horario.salida !== '-' ? horario.salida : '';
      document.getElementById('descansoHorario').value = horario.descanso;
      document.getElementById('zonaHorario').value = horario.zona;
      document.getElementById('observacionHorario').value = horario.observacion || '';
      modalHorario.show();
    }

    btnGuardarHorario.addEventListener('click', () => {
      const id = document.getElementById('horarioId').value;
      const dia = document.getElementById('diaHorario').value;
      const entrada = document.getElementById('entradaHorario').value || '-';
      const salida = document.getElementById('salidaHorario').value || '-';
      const descanso = document.getElementById('descansoHorario').value.trim() || '-';
      const zona = document.getElementById('zonaHorario').value || '-';
      const observacion = document.getElementById('observacionHorario').value.trim();

      if (!dia) { alert('El día es obligatorio'); return; }

      const diaExistente = horarios.find(h => h.dia === dia && h.id !== parseInt(id || 0));
      if (diaExistente) { alert('Ya existe un horario para ese día'); return; }

      if (id) {
        const index = horarios.findIndex(h => h.id === parseInt(id));
        if (index !== -1) {
          horarios[index] = { ...horarios[index], dia, entrada, salida, descanso, zona, observacion };
        }
      } else {
        const nuevoId = Math.max(...horarios.map(h => h.id), 0) + 1;
        horarios.push({ id:nuevoId, dia, entrada, salida, descanso, zona, observacion });
      }

      modalHorario.hide();
      renderTablaHorarios();
    });

    function eliminarHorario(id) {
      const horario = horarios.find(h => h.id === id);
      if (!horario) return;
      if (confirm(`¿Está seguro de que desea eliminar el horario del ${horario.dia}?`)) {
        horarios = horarios.filter(h => h.id !== id);
        renderTablaHorarios();
      }
    }

    document.getElementById("btnExportar").addEventListener("click", () => {
      const rows = Array.from(document.querySelectorAll("#tablaHorarios tr"));
      const csv = rows.map(r => Array.from(r.children).map(c => `"${c.textContent.replace(/\"/g,'\"\"')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "horarios.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
