<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contratos — Admin Fornería</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .brand{color:#dc3545;font-weight:700}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .pdf-frame{width:100%;height:70vh;border:1px solid #e9ecef;border-radius:.5rem;display:none}
    .table thead th{white-space:nowrap}
  </style>
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><span class="h4 m-0 brand">Fornería</span></a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <img src="https://via.placeholder.com/90" alt="mifoto" class="avatar">
        <span class="fw-semibold">Renato Muñoz (Admin)</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 d-none d-md-block">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title text-muted mb-3">NAVEGACIÓN</h6>
            <ul class="nav nav-pills flex-column gap-2">
              {% with n=request.resolver_match.url_name %}
              <li class="nav-item">
                <a class="nav-link {% if n == 'dash_admin' %}active{% endif %}" href="{% url 'dash_admin' %}">
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'crud_cargo' %}active{% endif %}" href="{% url 'crud_cargo' %}">
                  <i class="bi bi-briefcase me-2"></i>Gestión de Cargos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'contratos_admin' %}active{% endif %}" href="{% url 'contratos_admin' %}">
                  <i class="bi bi-file-earmark-text me-2"></i>Contratos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'liquidaciones_admin' %}active{% endif %}" href="{% url 'liquidaciones_admin' %}">
                  <i class="bi bi-cash-coin me-2"></i>Liquidaciones
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'horarios_admin' %}active{% endif %}" href="{% url 'horarios_admin' %}">
                  <i class="bi bi-clock me-2"></i>Horarios
                </a>
              </li>
              {% endwith %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="col-lg-10 col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="m-0">Contratos de empleados</h4>
          <div class="d-flex gap-2">
            <a class="btn btn-primary btn-sm" href="{% url 'contrato_create' %}">
              <i class="bi bi-plus-circle me-1"></i>Nuevo contrato
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'dash_admin' %}">Volver al panel</a>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
              <div class="d-flex gap-2">
                <input id="q" class="form-control form-control-sm" placeholder="Buscar por empleado, cargo o departamento">
                <button id="btnLimpiar" class="btn btn-outline-secondary btn-sm">Limpiar</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle" id="tablaContratos">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Empleado</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th class="text-nowrap">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for c in contratos %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ c.empleado }}</td>
                    <td>{{ c.cargo }}</td>
                    <td>{{ c.departamento }}</td>
                    <td>{{ c.fecha_inicio|date:"d-m-Y" }}</td>
                    <td>{{ c.fecha_fin|default:"—" }}</td>
                    <td class="text-nowrap">
                      <button
                        class="btn btn-sm btn-outline-primary btn-ver"
                        data-bs-toggle="offcanvas" data-bs-target="#offContrato"
                        data-nombre="{{ c.empleado }}"
                        data-cargo="{{ c.cargo }}"
                        data-depto="{{ c.departamento }}"
                        data-inicio="{{ c.fecha_inicio|date:"d-m-Y" }}"
                        data-fin="{{ c.fecha_fin|default:'' }}"
                        data-detalle="{{ c.detalle_contrato|default:'' }}"
                        data-pdf="{% if c.pdf %}{{ c.pdf.url }}{% endif %}">
                        Ver
                      </button>
                      <a class="btn btn-sm btn-outline-secondary" href="{% url 'contrato_edit' c.id %}" title="Editar">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <a class="btn btn-sm btn-outline-danger" href="{% url 'contrato_delete' c.id %}" title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="7" class="text-center text-muted">Sin contratos.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OFFCANVAS visor de contrato -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offContrato" aria-labelledby="offLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offLabel">Contrato</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-3">
        <div class="fw-bold" id="cNombre">—</div>
        <div class="text-muted small" id="cCargo">—</div>
        <div class="small text-muted" id="cDepto">—</div>
        <div class="mt-2">
          <span class="badge text-bg-secondary" id="cDetalle" style="display:none"></span>
        </div>
        <div class="small text-muted mt-1" id="cFechas">—</div>
      </div>

      <iframe class="pdf-frame" id="cPdf" src="" title="PDF contrato"></iframe>
      <div class="alert alert-light border d-none" id="sinPdf">Sin PDF adjunto para este contrato.</div>

      <div class="d-grid gap-2 mt-3">
        <a class="btn btn-primary d-none" id="btnDescargar" href="#" download>Descargar PDF</a>
        <button class="btn btn-outline-secondary" id="btnImprimir">Imprimir</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Filtro por texto (empleado/cargo/departamento) sobre filas ya renderizadas
    const q = document.getElementById("q");
    const btnLimpiar = document.getElementById("btnLimpiar");
    const tbody = document.querySelector("#tablaContratos tbody");

    function filtrar() {
      const term = q.value.trim().toLowerCase();
      Array.from(tbody.rows).forEach(tr => {
        const txt = tr.innerText.toLowerCase();
        tr.style.display = txt.includes(term) ? "" : "none";
      });
    }
    q.addEventListener("input", filtrar);
    btnLimpiar.addEventListener("click", () => { q.value = ""; filtrar(); });

    // Offcanvas "Ver" — carga los detalles usando data-*
    const off = document.getElementById("offContrato");
    const cNombre = document.getElementById("cNombre");
    const cCargo  = document.getElementById("cCargo");
    const cDepto  = document.getElementById("cDepto");
    const cDetalle= document.getElementById("cDetalle");
    const cFechas = document.getElementById("cFechas");
    const cPdf    = document.getElementById("cPdf");
    const sinPdf  = document.getElementById("sinPdf");
    const btnDesc = document.getElementById("btnDescargar");

    off.addEventListener("show.bs.offcanvas", (ev) => {
      const btn = ev.relatedTarget;
      if (!btn) return;

      const nombre = btn.getAttribute("data-nombre") || "—";
      const cargo  = btn.getAttribute("data-cargo") || "—";
      const depto  = btn.getAttribute("data-depto") || "—";
      const inicio = btn.getAttribute("data-inicio") || "";
      const fin    = btn.getAttribute("data-fin") || "";
      const detalle= btn.getAttribute("data-detalle") || "";
      const pdfUrl = btn.getAttribute("data-pdf") || "";

      cNombre.textContent = nombre;
      cCargo.textContent  = cargo;
      cDepto.textContent  = "Departamento: " + depto;

      if (detalle) {
        cDetalle.style.display = "";
        cDetalle.textContent = detalle;
      } else {
        cDetalle.style.display = "none";
      }

      const rango = inicio ? `Inicio: ${inicio}` + (fin ? ` — Fin: ${fin}` : "") : "—";
      cFechas.textContent = rango;

      if (pdfUrl) {
        cPdf.src = pdfUrl;
        cPdf.style.display = "";
        btnDesc.href = pdfUrl;
        btnDesc.classList.remove("d-none");
        sinPdf.classList.add("d-none");
      } else {
        cPdf.removeAttribute("src");
        cPdf.style.display = "none";
        btnDesc.classList.add("d-none");
        sinPdf.classList.remove("d-none");
      }
    });

    // Imprimir
    document.getElementById("btnImprimir").addEventListener("click", () => window.print());
  </script>
</body>
</html>
