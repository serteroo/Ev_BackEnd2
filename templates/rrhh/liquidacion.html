<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liquidaciones — Fornería</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .brand { color:#dc3545; font-weight:700; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><span class="h4 m-0 brand">Fornería</span></a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <img src="https://via.placeholder.com/90" alt="mifoto" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
        <span class="fw-semibold">Renato Muñoz</span>
      </div>
    </div>
  </nav>

  <!-- Contenido -->
  <div class="container-fluid py-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 d-none d-md-block">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title text-muted mb-3">NAVEGACIÓN</h6>
            <ul class="nav nav-pills flex-column gap-2">
              {% with n=request.resolver_match.url_name %}
              <li class="nav-item">
                <a class="nav-link {% if n == 'dash_admin' %}active{% endif %}" href="{% url 'dash_admin' %}">
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'crud_cargo' %}active{% endif %}" href="{% url 'crud_cargo' %}">
                  <i class="bi bi-briefcase me-2"></i>Gestión de Cargos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'contratos_admin' %}active{% endif %}" href="{% url 'contratos_admin' %}">
                  <i class="bi bi-file-earmark-text me-2"></i>Contratos
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'liquidaciones_admin' %}active{% endif %}" href="{% url 'liquidaciones_admin' %}">
                  <i class="bi bi-cash-coin me-2"></i>Liquidaciones
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if n == 'horarios_admin' %}active{% endif %}" href="{% url 'horarios_admin' %}">
                  <i class="bi bi-clock me-2"></i>Horarios
                </a>
              </li>
              {% endwith %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Contenido principal -->
      <div class="col-lg-10 col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="m-0">Mis liquidaciones</h4>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'dash_admin' %}">Volver al dashboard</a>
            <button class="btn btn-outline-primary btn-sm" id="btnDescargarTodo">Descargar todo</button>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="tablaLiquidaciones">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Mes</th>
                    <th>Año</th>
                    <th>Monto líquido</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody><!-- filas dinámicas --></tbody>
              </table>
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación de liquidaciones">
              <ul class="pagination justify-content-center" id="paginador"><!-- items dinámicos --></ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const data = [];
    for (let i = 0; i < 30; i++) {
      const mes = meses[(10 + i) % 12];
      const anio = 2024 + Math.floor(i/12);
      data.push({
        id: i + 1,
        mes,
        anio,
        monto: `$${(900000 + (i*3500)).toLocaleString('es-CL')}`,
        estado: i % 5 === 0 ? "Archivado" : "Disponible"
      });
    }

    const PAGE_SIZE = 10;
    const TOTAL_PAGES = Math.ceil(data.length / PAGE_SIZE);
    const STORAGE_KEY = "liqCurrentPage";

    function getInitialPage() {
      const q = new URLSearchParams(location.search);
      if (q.has("page")) {
        const p = parseInt(q.get("page"), 10);
        if (!isNaN(p) && p >= 1 && p <= TOTAL_PAGES) {
          localStorage.setItem(STORAGE_KEY, String(p));
          return p;
        }
      }
      const saved = parseInt(localStorage.getItem(STORAGE_KEY) || "1", 10);
      if (!isNaN(saved) && saved >= 1 && saved <= TOTAL_PAGES) return saved;
      return 1;
    }

    let currentPage = getInitialPage();

    function renderTable(page) {
      const tbody = document.querySelector("#tablaLiquidaciones tbody");
      tbody.innerHTML = "";
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const slice = data.slice(start, end);

      slice.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${start + idx + 1}</td>
          <td>${row.mes}</td>
          <td>${row.anio}</td>
          <td>${row.monto}</td>
          <td>${row.estado === "Disponible" ? 
            '<span class="badge text-bg-success">Disponible</span>' : 
            '<span class="badge text-bg-secondary">Archivado</span>'}
          </td>
          <td>
            <button class="btn btn-sm btn-primary">Ver</button>
            <button class="btn btn-sm btn-outline-secondary">PDF</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPagination(page) {
      const ul = document.getElementById("paginador");
      ul.innerHTML = "";

      const addItem = (label, disabled, active, onClick) => {
        const li = document.createElement("li");
        li.className = `page-item${disabled ? " disabled" : ""}${active ? " active" : ""}`;
        const a = document.createElement("a");
        a.className = "page-link";
        a.href = "#";
        a.textContent = label;
        if (!disabled) a.addEventListener("click", (e) => { e.preventDefault(); onClick(); });
        li.appendChild(a);
        ul.appendChild(li);
      };

      addItem("«", page === 1, false, () => changePage(page - 1));
      for (let p = 1; p <= TOTAL_PAGES; p++) {
        addItem(String(p), false, p === page, () => changePage(p));
      }
      addItem("»", page === TOTAL_PAGES, false, () => changePage(page + 1));
    }

    function changePage(p) {
      currentPage = p;
      localStorage.setItem(STORAGE_KEY, String(currentPage));
      renderTable(currentPage);
      renderPagination(currentPage);
      const url = new URL(location);
      url.searchParams.set("page", String(currentPage));
      history.replaceState({}, "", url);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    renderTable(currentPage);
    renderPagination(currentPage);

    document.getElementById("btnDescargarTodo").addEventListener("click", () => {
      alert("Aquí iría la descarga de todas las liquidaciones (implementación backend).");
    });
  </script>
</body>
</html>
